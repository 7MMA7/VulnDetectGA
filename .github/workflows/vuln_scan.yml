name: Vulnerability Benchmarker

on:
  push:
    branches: [main]

jobs:
  analyze-vulns:
    runs-on: ubuntu-latest
    
    services:
      sonarqube:
        image: sonarqube:community
        ports:
          - 9000:9000
        options: --health-cmd="curl -f http://localhost:9000/api/system/status || exit 1" --health-interval=10s --health-timeout=5s --health-retries=20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests gitpython
          sudo apt-get install -y unzip

      - name: Install Sonar Scanner
        run: |
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner-cli-5.0.1.3006-linux.zip
          mv sonar-scanner-5.0.1.3006-linux sonar-scanner
          echo "$PWD/sonar-scanner/bin" >> $GITHUB_PATH

      - name: Wait for SonarQube
        run: |
          echo "Waiting for SonarQube..."
          until [[ "$(curl -s -u admin:admin http://localhost:9000/api/system/status | grep -o '"status":"UP"')" != "" ]]; do
            sleep 5
            echo "Still waiting..."
          done
          echo "SonarQube is UP!"

      - name: Configure SonarQube Auth
        id: sonar-auth
        run: |
          curl -u admin:admin -X POST "http://localhost:9000/api/users/change_password?login=admin&previousPassword=admin&password=securepass"
          TOKEN=$(curl -u admin:securepass -X POST "http://localhost:9000/api/user_tokens/generate?name=ci-token" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Run Analysis Script
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        run: |
          cat <<EOF > script.py
          import json, os, re, time, subprocess, requests, shutil
          from git import Repo

          SONAR_URL = "http://localhost:9000"
          SONAR_TOKEN = os.environ["SONAR_TOKEN"]
          WORKDIR = "workdir"
          
          if not os.path.exists(WORKDIR): os.makedirs(WORKDIR)

          def patch_file(file_path, func_code):
              try:
                  with open(file_path, 'r', errors='ignore') as f: content = f.read()
                  match = re.search(r'(\w+\s+)+\**(\w+)\s*\(', func_code)
                  if not match: return False
                  func_name = match.group(2)
                  idx = content.find(func_name + "(")
                  if idx == -1: idx = content.find(func_name + " (")
                  if idx == -1: return False
                  pre = content[:idx]
                  last_brace = pre.rfind('}')
                  insertion_point = last_brace + 1 if last_brace != -1 else 0
                  open_brace = content.find('{', idx)
                  count = 1
                  end_pos = -1
                  for i in range(open_brace+1, len(content)):
                      if content[i] == '{': count+=1
                      elif content[i] == '}': count-=1
                      if count == 0:
                          end_pos = i+1
                          break
                  if end_pos == -1: return False
                  new_content = content[:insertion_point] + "\n" + func_code + "\n" + content[end_pos:]
                  with open(file_path, 'w') as f: f.write(new_content)
                  return True
              except Exception as e:
                  print(f"Error patching: {e}")
                  return False

          results = []
          with open("chunk_00.jsonl", "r") as f:
              for line in f:
                  entry = json.loads(line)
                  project_key = f"prj_{entry['idx']}_{entry['target']}"
                  print(f"Processing {project_key}...")
                  repo_path = os.path.join(WORKDIR, project_key)
                  if os.path.exists(repo_path): shutil.rmtree(repo_path)
                  repo = Repo.clone_from(entry['project_url'], repo_path)
                  repo.git.checkout(entry['commit_id'])
                  patched = patch_file(os.path.join(repo_path, entry['file_path']), entry['func'])
                  if patched:
                      cmd = [
                          "sonar-scanner",
                          f"-Dsonar.projectKey={project_key}",
                          "-Dsonar.sources=.",
                          f"-Dsonar.host.url={SONAR_URL}",
                          f"-Dsonar.login={SONAR_TOKEN}",
                          "-Dsonar.scm.disabled=true",
                          "-Dsonar.c.file.suffixes=.c,.h",
                          "-Dsonar.cpp.file.suffixes=.cpp,.hpp"
                      ]
                      subprocess.run(cmd, cwd=repo_path, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                      time.sleep(3)
                      while True:
                          r = requests.get(f"{SONAR_URL}/api/ce/component", params={"component": project_key}, auth=(SONAR_TOKEN, ''))
                          if not r.json().get('queue') and not r.json().get('current'): break
                          time.sleep(1)
                      issues = requests.get(f"{SONAR_URL}/api/issues/search", params={"componentKeys": project_key, "types": "VULNERABILITY"}, auth=(SONAR_TOKEN, '')).json()
                      results.append({"idx": entry['idx'], "target": entry['target'], "issues": len(issues.get('issues', []))})
                  else:
                      print("Patch failed")
          with open("final_results.json", "w") as f: json.dump(results, f)
          EOF
          python script.py

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: sonar-analysis-results
          path: final_results.json
