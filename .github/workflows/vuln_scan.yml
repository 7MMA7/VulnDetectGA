name: Vulnerability Benchmarker

on:
  push:
    branches: [main]

jobs:
  analyze-vulns:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests gitpython

      - name: Run Patch Script
        run: |
          cat <<EOF > script.py
          import json
          import os
          import re
          import time
          import subprocess
          import requests
          import shutil
          from git import Repo

          WORKDIR = "workdir"
          os.makedirs(WORKDIR, exist_ok=True)

          def patch_file(file_path, func_code):
              try:
                  with open(file_path, 'r', errors='ignore') as f:
                      content = f.read()
                  match = re.search(r'(\\w+\\s+)+\\**(\\w+)\\s*\\(', func_code)
                  if not match: return False
                  func_name = match.group(2)
                  idx = content.find(func_name + "(")
                  if idx == -1: idx = content.find(func_name + " (")
                  if idx == -1: return False
                  pre = content[:idx]
                  last_brace = pre.rfind('}')
                  insertion_point = last_brace + 1 if last_brace != -1 else 0
                  open_brace = content.find('{', idx)
                  count = 1
                  end_pos = -1
                  for i in range(open_brace + 1, len(content)):
                      if content[i] == '{': count += 1
                      elif content[i] == '}': count -= 1
                      if count == 0: end_pos = i + 1; break
                  if end_pos == -1: return False
                  new_content = content[:insertion_point] + "\\n" + func_code + "\\n" + content[end_pos:]
                  with open(file_path, 'w') as f: f.write(new_content)
                  return True
              except: return False

          results = []
          with open("chunk_00.jsonl", "r") as f:
              for line in f:
                  entry = json.loads(line)
                  project_key = f"prj_{entry['idx']}_{entry['target']}"
                  repo_path = os.path.join(WORKDIR, project_key)
                  if os.path.exists(repo_path): shutil.rmtree(repo_path)
                  repo = Repo.clone_from(entry["project_url"], repo_path)
                  repo.git.checkout(entry["commit_id"])
                  if not patch_file(os.path.join(repo_path, entry["file_path"]), entry["func"]): continue
                  results.append({"idx": entry["idx"], "target": entry["target"], "repo_path": repo_path})
          with open("patched_repos.json", "w") as f: json.dump(results, f)
          EOF

          python script.py

      - name: Run SonarQube Analysis
        uses: sonarsource/sonarcloud-github-action@master
        with:
          projectBaseDir: .
          extraProperties: |
            sonar.projectKey=VulnDetectGA
            sonar.organization=my-org
            sonar.sources=.
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: patched-results
          path: patched_repos.json
